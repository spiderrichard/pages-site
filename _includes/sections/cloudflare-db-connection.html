<style>
.cloudflare-db-connection h2 {
	margin: var(--contentGap) 0;
}

.cloudflare-db-connection .content-container {
	margin: 50px 0;
}

.entry-form {
    display: flex;
    gap: 10px;
    background: cornflowerblue;
    padding: 10px;
    border-radius: 5px;
}

.entry-form-input {
    flex: 1;
    font-size: 16px;
    padding: 5px;
    border: none;
    border-radius: 5px;
}
</style>
<section class="cloudflare-db-connection">
    <div class="width-control">
        <div class="content-container">
            <h2 class="section-header">Cloudflare Database Connection</h2>
            <p class="section-description">Use the form below to enter a test message to my cloudflare database and watch the table below update with the results!</p>

            <form id="entryForm" class="entry-form">
                <input id="value" class="entry-form-input" placeholder="Type something..." required />
                <button type="submit">Submit</button>
            </form>

            <p id="msg"></p>

            <table id="entriesTable" style="margin-top: 1rem; width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #ccc;">Message</th>
                  <th style="text-align:left; border-bottom:1px solid #ccc;">Created</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>
    </div>
</section>
<script>
    (function () {
		const form = document.getElementById("entryForm");
		const input = document.getElementById("value");
		const msg = document.getElementById("msg");
	
		if (!form || !input) return;
	
		const API_BASE = "https://example-database.spiderrichard.workers.dev";
	
		form.addEventListener("submit", async (e) => {
			e.preventDefault();
	
			const value = input.value.trim();
			if (!value) return;
	
			msg && (msg.textContent = "Saving...");
	
			try {
			const res = await fetch(`${API_BASE}/api/entry`, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ value }),
			});
	
			if (!res.ok) throw new Error(await res.text());
	
			input.value = "";
			msg && (msg.textContent = "Saved ✅");
			} catch (err) {
			console.error(err);
			msg && (msg.textContent = "Error saving ❌");
			}
		});
    })();

    (function () {
    const API_BASE = "https://example-database.spiderrichard.workers.dev";
    const tbody = document.querySelector("#entriesTable tbody");

    if (!tbody) return;

    async function loadEntries() {
		try {
			const res = await fetch(`${API_BASE}/api/entries`);
			if (!res.ok) throw new Error(await res.text());

			const data = await res.json();

			tbody.innerHTML = "";

			data.results.forEach(row => {
			const tr = document.createElement("tr");

			tr.innerHTML = `
				<td style="padding:0.5rem 0;">${row.code}</td>
				<td style="padding:0.5rem 0;">${row.created_at}</td>
			`;

			tbody.appendChild(tr);
			});
		} catch (err) {
			console.error("Failed to load entries", err);
		}
    }

    loadEntries();
  	})();
  </script>